<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Admin | EBIKE</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: #f0f2f5; display: flex; height: 100vh; margin: 0; }
        aside { width: 250px; background: #111; color: white; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        aside h2 { color: #e65a00; margin-bottom: 20px; }
        aside button { background: none; border: none; color: #ddd; text-align: left; padding: 15px; cursor: pointer; font-size: 1rem; border-radius: 5px; }
        aside button:hover, aside button.active { background: #333; color: #e65a00; }
        main { flex: 1; padding: 40px; overflow-y: auto; }
        .section { display: none; }
        .section.active { display: block; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        input { padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 5px; width: 100%; }
        .hint { font-size: 0.8rem; color: #666; margin-bottom: 10px; display: block; }
        .btn-add { background: #e65a00; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; }
        .btn-delete { color: red; cursor: pointer; border: none; background: none; }
        .btn-admin { color: #1a73e8; cursor: pointer; border: none; background: none; font-weight: bold; }
        .tag-admin { background: #1a73e8; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.8rem; }
        img.thumb { width: 50px; height: 50px; object-fit: contain; border-radius: 5px; background: #eee; }
    </style>
</head>
<body>
    <aside>
        <h2>EBIKE SYSTEM</h2>
        <button onclick="showSection('produtos')" class="active">üì¶ Produtos</button>
        <button onclick="showSection('usuarios')">üë• Usu√°rios</button>
        <button onclick="showSection('site')">üñºÔ∏è Capa do Site</button>
        <button onclick="showSection('pedidos')">üõí Pedidos</button>
        <button onclick="window.location.href='index.html'" style="margin-top:auto; color:#aaa">‚¨Ö Voltar ao Site</button>
    </aside>

    <main>
        <div id="produtos" class="section active">
            <h1>Estoque de Produtos</h1>
            <div class="card" style="background: #fff8f0; border: 1px solid #e65a00;">
                <h3>+ Novo Produto</h3>
                <input type="text" id="pName" placeholder="Nome">
                <input type="number" id="pPrice" placeholder="Pre√ßo (R$)">
                <input type="text" id="pDesc" placeholder="Descri√ß√£o">
                
                <label style="font-weight:bold; margin-top:10px; display:block">Foto do Produto:</label>
                <span class="hint">Recomendado: 800 x 800 px (Quadrada) | Formato PNG ou JPG</span>
                <input type="file" id="pImage">
                
                <button class="btn-add" onclick="addProduto()">Salvar Produto</button>
            </div>
            <div class="card">
                <table>
                    <thead><tr><th>Img</th><th>C√≥d</th><th>Nome</th><th>Pre√ßo</th><th>A√ß√£o</th></tr></thead>
                    <tbody id="produtosTable"></tbody>
                </table>
            </div>
        </div>

        <div id="usuarios" class="section">
            <h1>Gerenciar Usu√°rios</h1>
            <div class="card">
                <table>
                    <thead><tr><th>C√≥d</th><th>Nome</th><th>Email</th><th>Cargo</th><th>A√ß√µes</th></tr></thead>
                    <tbody id="usersTable"></tbody>
                </table>
            </div>
        </div>

        <div id="site" class="section">
            <h1>Personalizar Site</h1>
            <div class="card">
                <h3>Imagem Principal (Banner)</h3>
                <span class="hint">Recomendado: 1920 x 600 px (Horizontal) | Fundo transparente ou escuro fica melhor.</span>
                <input type="file" id="bannerImage">
                <button class="btn-add" onclick="uploadBanner()">Atualizar Capa</button>
                <br><br>
                <img id="currentBanner" src="" style="max-width: 100%; height: 200px; object-fit: contain; background: #333; border-radius: 10px;">
            </div>
        </div>

        <div id="pedidos" class="section">
            <h1>Pedidos</h1>
            <div id="ordersList"></div>
        </div>
    </main>

    <script>
        const API = 'http://localhost:3000/api';
        
        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('aside button').forEach(b => b.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            if(id === 'produtos') loadProdutos();
            if(id === 'usuarios') loadUsers();
            if(id === 'site') loadBanner();
            if(id === 'pedidos') loadPedidos();
        }

        // --- PRODUTOS ---
        async function loadProdutos() {
            const res = await fetch(`${API}/produtos`);
            const items = await res.json();
            const tbody = document.getElementById('produtosTable');
            tbody.innerHTML = '';
            items.forEach(i => {
                tbody.innerHTML += `
                    <tr>
                        <td><img src="${i.image}" class="thumb"></td>
                        <td><b>${i.code}</b></td>
                        <td>${i.name}</td>
                        <td>R$ ${i.price.toLocaleString('pt-BR')}</td>
                        <td><button class="btn-delete" onclick="deleteProduto(${i.id})">Excluir</button></td>
                    </tr>`;
            });
        }

        async function addProduto() {
            const nameEl = document.getElementById('pName');
            const priceEl = document.getElementById('pPrice');
            const descEl = document.getElementById('pDesc');
            const fileEl = document.getElementById('pImage');

            if(!nameEl.value || !priceEl.value) return alert('Preencha os dados!');

            const fd = new FormData();
            fd.append('name', nameEl.value); 
            fd.append('price', priceEl.value); 
            fd.append('description', descEl.value);
            if(fileEl.files[0]) fd.append('image', fileEl.files[0]);

            await fetch(`${API}/produtos`, { method: 'POST', body: fd });
            loadProdutos();
            alert('Produto salvo!');
            
            // LIMPA OS CAMPOS (Pedido atendido)
            nameEl.value = '';
            priceEl.value = '';
            descEl.value = '';
            fileEl.value = '';
        }

        async function deleteProduto(id) {
            if(confirm('Excluir?')) {
                await fetch(`${API}/produtos/${id}`, { method: 'DELETE' });
                loadProdutos();
            }
        }

        // --- USU√ÅRIOS ---
        async function loadUsers() {
            const res = await fetch(`${API}/users`);
            const users = await res.json();
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = '';
            users.forEach(u => {
                const isAdmin = u.role === 'admin';
                const roleBadge = isAdmin ? '<span class="tag-admin">ADMIN</span>' : 'Cliente';
                const actionBtn = isAdmin 
                    ? `<button class="btn-delete" onclick="changeRole(${u.id}, 'user')">Rebaixar</button>`
                    : `<button class="btn-admin" onclick="changeRole(${u.id}, 'admin')">Tornar Admin</button>`;

                tbody.innerHTML += `
                    <tr>
                        <td>${u.code}</td>
                        <td>${u.name}</td>
                        <td>${u.email}</td>
                        <td>${roleBadge}</td>
                        <td>
                            ${actionBtn}
                            <button class="btn-delete" onclick="deleteUser(${u.id})" style="margin-left:10px">X</button>
                        </td>
                    </tr>`;
            });
        }

        async function changeRole(id, newRole) {
            if(confirm(`Mudar cargo para ${newRole}?`)) {
                await fetch(`${API}/users/${id}/role`, {
                    method: 'PUT', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ role: newRole })
                });
                loadUsers();
            }
        }

        async function deleteUser(id) {
            if(confirm('Excluir usu√°rio permanentemente?')) {
                await fetch(`${API}/users/${id}`, { method: 'DELETE' });
                loadUsers();
            }
        }

        // --- BANNER ---
        async function uploadBanner() {
            const file = document.getElementById('bannerImage').files[0];
            if(!file) return alert('Selecione uma imagem');
            const fd = new FormData();
            fd.append('image', file);
            const res = await fetch(`${API}/config/banner`, { method: 'POST', body: fd });
            const data = await res.json();
            document.getElementById('currentBanner').src = data.image;
            alert('Capa atualizada!');
        }
        async function loadBanner() {
            const res = await fetch(`${API}/config/banner`);
            const data = await res.json();
            if(data.image) document.getElementById('currentBanner').src = data.image;
        }

        // --- PEDIDOS ---
        async function loadPedidos() {
            const res = await fetch(`${API}/pedidos`);
            const pedidos = await res.json();
            document.getElementById('ordersList').innerHTML = pedidos.map(p => `
                <div class="card">
                    <h3>Pedido #${p.id.substr(0,8)}...</h3>
                    <p>Cliente: ${p.user_name || 'Visitante'} (${p.user_code || '-'})</p>
                    <p>Total: R$ ${p.total.toLocaleString('pt-BR')}</p>
                    <ul>${p.itens.map(i => `<li>${i.qty}x ${i.name}</li>`).join('')}</ul>
                </div>
            `).join('');
        }

        loadProdutos();
    </script>
</body>
</html>